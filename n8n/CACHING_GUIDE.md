# Кэширование запросов к Firecrawl API в n8n

## Обзор

Кэширование позволяет избежать повторных запросов к Firecrawl API для одних и тех же URL, что экономит время и ресурсы.

## Как работает кэширование

### 1. Проверка кэша
- Создается уникальный ключ на основе URL
- Проверяется наличие данных в `$workflow.getStaticData('global')`
- Если данные есть и не устарели (младше 1 часа), возвращаются из кэша

### 2. Сохранение в кэш
- После успешного запроса к Firecrawl данные сохраняются в кэш
- Добавляется метка времени для контроля устаревания

### 3. Управление кэшем
- Автоматическое удаление устаревших записей
- Ключи кэша основаны на base64-кодированном URL

## Структура кэша

```javascript
$workflow.getStaticData('global')[cacheKey] = {
  data: firecrawlData,        // Данные от Firecrawl
  timestamp: Date.now(),      // Время создания
  url: url                    // Исходный URL
};
```

## Настройка времени жизни кэша

В коде можно изменить время жизни кэша:

```javascript
const maxAge = 60 * 60 * 1000; // 1 час в миллисекундах
```

Варианты:
- `30 * 60 * 1000` - 30 минут
- `2 * 60 * 60 * 1000` - 2 часа
- `24 * 60 * 60 * 1000` - 24 часа

## Workflows с кэшированием

### create_news_cached.json
- Полный workflow создания постов с кэшированием
- Проверяет кэш перед запросом к Firecrawl
- Сохраняет результат в кэш после успешного запроса

### regenerate_post_cached.json
- Workflow перегенерации с кэшированием
- Использует тот же механизм кэширования

## Преимущества кэширования

1. **Экономия времени** - повторные запросы выполняются мгновенно
2. **Экономия ресурсов** - меньше запросов к Firecrawl API
3. **Стабильность** - меньше зависимости от внешних сервисов
4. **Отладка** - можно видеть, откуда пришли данные (кэш или API)

## Мониторинг кэша

В ответе добавляются поля:
- `fromCache: true/false` - источник данных
- `cacheAge: number` - возраст кэша в минутах (только для кэша)

## Очистка кэша

Кэш автоматически очищается при:
- Устаревании записей (старше maxAge)
- Перезапуске n8n (если используется memory storage)

Для принудительной очистки можно добавить узел:

```javascript
// Очистка всего кэша
$workflow.getStaticData('global') = {};
return [{ json: { cleared: true } }];
```

## Рекомендации

1. **Время жизни**: 1-2 часа оптимально для новостных сайтов
2. **Мониторинг**: Следите за размером кэша в production
3. **Тестирование**: Проверьте работу кэша на разных URL
4. **Логирование**: Добавьте логи для отслеживания hit/miss ratio

## Пример использования

```bash
# Первый запрос - идет в Firecrawl
curl -X POST https://your-n8n.com/webhook/create_news \
  -d '{"link": "https://example.com/news"}'

# Второй запрос - берется из кэша
curl -X POST https://your-n8n.com/webhook/create_news \
  -d '{"link": "https://example.com/news"}'
```

## Troubleshooting

### Кэш не работает
- Проверьте, что используется `$workflow.getStaticData('global')`
- Убедитесь, что ключи кэша создаются одинаково

### Кэш не очищается
- Проверьте логику устаревания
- Убедитесь, что `maxAge` установлен правильно

### Слишком много памяти
- Уменьшите время жизни кэша
- Добавьте ограничение на количество записей
