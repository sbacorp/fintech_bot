# Система управления каналами

## Обзор

Бот теперь поддерживает систему управления каналами через базу данных Supabase. Пользователи могут создавать, управлять и выбирать каналы для публикации новостей.

## Новые команды

### `/add_channel`
Запускает интерактивный процесс создания нового канала. Пользователь заполняет:
- Название канала
- Описание канала
- Username канала в Telegram (например: @mychannel)
- ID канала в Telegram (например: -1001234567890)
- Источники новостей (URL через запятую)
- Промпт для ИИ
- Проверка прав администратора у бота в канале

### `/select_channel`
Показывает список каналов пользователя и позволяет выбрать активный канал для работы.

## Структура базы данных

### Таблица `channels`

```sql
CREATE TABLE channels (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id BIGINT NOT NULL, -- Telegram user ID
    name VARCHAR(255) NOT NULL, -- Название канала
    description TEXT, -- Описание канала
    sources TEXT[], -- Массив ссылок на источники новостей
    channel_username VARCHAR(255), -- Username канала (например, @mychannel)
    channel_id BIGINT, -- ID канала в Telegram
    is_admin_verified BOOLEAN DEFAULT FALSE, -- Проверка прав админа у бота в канале
    ai_prompt TEXT, -- Промпт для ИИ
    is_active BOOLEAN DEFAULT TRUE, -- Активен ли канал
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Установка

1. Выполните SQL скрипт `supabase-channels-table.sql` в вашей базе данных Supabase
2. Убедитесь, что переменные окружения `SUPABASE_URL` и `SUPABASE_ANON_KEY` настроены
3. Перезапустите бота

## Использование

### Создание канала

1. Отправьте команду `/add_channel`
2. Следуйте инструкциям бота для заполнения информации о канале
3. Добавьте бота в ваш канал как администратора
4. Проверьте права администратора через бота

### Выбор канала

1. Отправьте команду `/select_channel`
2. Выберите канал из списка ваших каналов
3. Теперь все команды будут работать с выбранным каналом

### Автоматический выбор

Если у пользователя только один канал, он будет выбран автоматически при первом использовании команд.

## Особенности

- **Безопасность**: Каждый пользователь видит только свои каналы
- **Валидация**: Проверка прав администратора у бота в канале
- **Гибкость**: Настройка промптов ИИ для каждого канала
- **Источники**: Индивидуальные источники новостей для каждого канала
- **Статус**: Возможность деактивации каналов без удаления

## API методы

### SupabaseService

- `saveChannel(channelData)` - Сохранение нового канала
- `getUserChannels(userId)` - Получение каналов пользователя
- `getChannelById(channelId)` - Получение канала по ID
- `updateChannel(channelId, updates)` - Обновление канала
- `deleteChannel(channelId)` - Удаление канала (деактивация)

## Callback кнопки

- `add_new_channel` - Добавить новый канал
- `select_another_channel` - Выбрать другой канал
- `my_channels` - Показать мои каналы
- `cancel_channel_selection` - Отменить выбор канала
- `main_menu` - Вернуться в главное меню

## Миграция с старой системы

Старая система каналов из `.env` файла больше не используется. Все каналы теперь хранятся в базе данных и управляются через интерфейс бота.

## Troubleshooting

### Канал не найден
- Убедитесь, что канал создан через `/add_channel`
- Проверьте, что канал активен (не удален)

### Нет прав администратора
- Добавьте бота в канал как администратора
- Используйте кнопку "Проверить права" в процессе создания канала

### Ошибки базы данных
- Проверьте подключение к Supabase
- Убедитесь, что таблица `channels` создана
- Проверьте права доступа к базе данных
